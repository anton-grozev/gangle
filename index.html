<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Side Clearance Angle Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="main-title">üîß –ö–ê–õ–ö–£–õ–ê–¢–û–† –ó–ê –ò–ó–ß–ò–°–õ–Ø–í–ê–ù–ï –ù–ê –†–ê–ë–û–¢–ï–ù –ó–ê–î–ï–ù –™–ì–™–õ Œ±<sub>f</sub> –ù–ê –í–ò–ù–¢–û–í–û –°–í–†–ï–î–õ–û</h1>
        </header>
        <!-- –õ–Ø–í–ê –ö–û–õ–û–ù–ê - –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –î–ê–ù–ù–ò -->
        <div class="left-column">
            <div class="input-container">
                <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏ —Å–ª–∞–π–¥–µ—Ä–∏ -->
                <div class="interactive-section" id="interactive-section" style="display: block;">
                    <div class="slider-container">
                        <div class="slider-group">
                            <label for="l-slider" id="l-label">üìè l [mm] - –†–∞–∑—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –≤—ä—Ä—Ö–∞ –Ω–∞ –∫–æ–Ω—É—Å–∞:</label>
                            <div class="slider-row">
                                <input id="l-slider" type="range" min="10" max="200" step="0.1" value="85">
                                <input id="l-slider-num" class="slider-num" type="number" step="0.1" value="85">
                            </div>
                        </div>
                        <div class="slider-group">
                            <label for="d-slider" id="d-label">üìè d [mm] - –†–∞–∑—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –æ—Å–∏—Ç–µ:</label>
                            <div class="slider-row">
                                <input id="d-slider" type="range" min="0" max="50" step="0.1" value="5.7">
                                <input id="d-slider-num" class="slider-num" type="number" step="0.1" value="5.7">
                            </div>
                        </div>
                        <div class="slider-group">
                            <label for="theta-slider" id="theta-label">üìê Œ∏ [¬∞] - –™–≥—ä–ª –º–µ–∂–¥—É –æ—Å–∏—Ç–µ –Ω–∞ —Å–≤—Ä–µ–¥–ª–æ—Ç–æ –∏ –∫–æ–Ω—É—Å–∞:</label>
                            <div class="slider-row">
                                <input id="theta-slider" type="range" min="0" max="59" step="0.1" value="25" disabled style="opacity: 0.5;">
                                <input id="theta-slider-num" class="slider-num" type="number" step="0.1" value="25" disabled style="opacity: 0.5;">
                                <label style="display: flex; align-items: center; gap: 5px; margin-left: 10px; white-space: nowrap;">
                                    <input type="checkbox" id="theta-lock" checked style="width: auto; height: auto;">
                                    <span id="theta-lock-label">üîí –ó–∞–∫–ª—é—á–∏</span>
                                </label>
                            </div>
                        </div>
                        <div class="slider-group">
                            <label for="beta-slider" id="beta-label">üìê Œ≤ [¬∞] - –™–≥—ä–ª –º–µ–∂–¥—É –æ—Å—Ç–∞ –Ω–∞ –∫–æ–Ω—É—Å–∞ –∏ –æ–±—Ä–∞–∑—É–≤–∞—â–∞—Ç–∞:</label>
                            <div class="slider-row">
                                <input id="beta-slider" type="range" min="0" max="59" step="0.1" value="34" disabled style="opacity: 0.5;">
                                <input id="beta-slider-num" class="slider-num" type="number" step="0.1" value="34" disabled style="opacity: 0.5;">
                            </div>
                        </div>
                        <div class="sum-control">
                            <div class="radio-option">
                                <label><input type="radio" name="anglePreset" value="none"> –ë–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–∞–Ω–µ</label>
                            </div>
                            <div class="radio-option">
                                <label><input type="radio" name="anglePreset" value="59" checked> Œ∏ + Œ≤ = 59¬∞ (Kr = 118¬∞)</label>
                            </div>
                            <div class="radio-option">
                                <label><input type="radio" name="anglePreset" value="62.5"> Œ∏ + Œ≤ = 62.5¬∞ (Kr = 125¬∞)</label>
                            </div>
                            <div class="radio-option">
                                <label><input type="radio" name="anglePreset" value="67.5"> Œ∏ + Œ≤ = 67.5¬∞ (Kr = 135¬∞)</label>
                            </div>
                        </div>
                        <hr style="margin: 16px 0; border: 1px solid #e6e9ef;">
                        <div class="coord-control">
                            <label id="coord-label">üìç SW –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–∞ —Ç–æ—á–∫–∞—Ç–∞ (—Å–ø—Ä—è–º–æ –≤—ä—Ä—Ö–∞ –Ω–∞ —Å–≤—Ä–µ–¥–ª–æ—Ç–æ):</label>
                            <div class="coord-inputs">
                                <input id="x-slider" type="number" step="0.01" value="0" placeholder="X [mm]">
                                <input id="y-slider" type="number" step="0.01" value="4.84" placeholder="Y [mm]">
                                <input id="z-slider" type="number" step="0.01" value="-9.75" placeholder="Z [mm]">
                            </div>
                        </div>
                        <div class="realtime-result">
                            <div class="result-big" id="alphaValue">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
                            <div id="statusBadge" class="status-badge waiting" style="display: none;">–∏–∑—á–∏—Å–ª—è–≤–∞ —Å–µ...</div>
                            <div class="auxiliary-values">
                                xM: <span id="xMval">‚Äî</span> ¬∑ h: <span id="hVal">‚Äî</span>
                            </div>
                        </div>
                        
                        <!-- –¢–æ–ø–ª–∏–Ω–Ω–∞ –∫–∞—Ä—Ç–∞/–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
                        <div class="range-indicator">
                            <div class="range-track" id="rangeTrack">
                                <div id="marker" class="marker" style="left:0%" title="alpha position"></div>
                            </div>
                            <div class="range-labels">
                                <span>0¬∞</span><span>5¬∞ (min)</span><span>20¬∞</span><span>35¬∞ (max)</span><span>40¬∞</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-reset" id="reset-btn" onclick="resetInteractiveForm()">üîÑ –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ</button>
                </div>
                <div class="error" id="error-message"></div>
            </div>
        </div>
        <!-- RIGHT COLUMN - HISTORY / –î–Ø–°–ù–ê –ö–û–õ–û–ù–ê - –ò–°–¢–û–†–ò–Ø -->
        <div class="right-column">
            <!-- –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞ -->
            <div class="history-section" id="history-section">
                <h3 id="history-title">üìö –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞</h3>
                
                <div class="history-controls">
                    <button class="save-btn" id="save-btn" onclick="saveToHistory()">üíæ –ó–∞–ø–∞–∑–∏</button>
                    <button class="clear-history-btn" id="clear-history-btn" onclick="clearHistory()">üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</button>
                </div>
                
                <div class="history-container" id="history-container">
                    <!-- –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ —â–µ —Å–µ –∑–∞—Ä–µ–¥–∏ —Ç—É–∫ –¥–∏–Ω–∞–º–∏—á–Ω–æ -->
                </div>
            </div>
        </div>
    </div>

    <button class="lang-toggle" id="lang-toggle" onclick="toggleLanguage()" title="Switch Language / –°–º–µ–Ω–∏ –µ–∑–∏–∫">
        <span id="lang-text">EN</span>
    </button>
    <button class="dark-mode-toggle" id="dark-mode-toggle" onclick="toggleDarkMode()" title="–í–∫–ª—é—á–∏/–ò–∑–∫–ª—é—á–∏ —Ç—ä–º–µ–Ω —Ä–µ–∂–∏–º">üåô</button>
    
    <!-- Load external JavaScript library -->
    <script src="GAngle.js"></script>
    <script src="translations.js"></script>
    <script>
        let currentMode = 'sw';
        let currentLanguage = 'bg';
        
        // –ì–ª–æ–±–∞–ª–µ–Ω –±—Ä–æ—è—á –∑–∞ –Ω–æ–º–µ—Ä–∞—Ü–∏—è –Ω–∞ –∑–∞–ø–∞–∑–µ–Ω–∏—Ç–µ —Ç–æ—á–∫–∏
        let savedPointCounter = parseInt(localStorage.getItem('savedPointCounter') || '0');
        
        // Function to toggle language
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'bg' ? 'en' : 'bg';
            updateLanguage();
            localStorage.setItem('language', currentLanguage);
        }

        // Function to set language (for backward compatibility)
        function setLanguage(lang) {
            currentLanguage = lang;
            updateLanguage();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                resetForm();
            }
        });
        // Load dark mode on page load
        window.addEventListener('load', function() {
            loadDarkMode();
            setupValidation();
            setupTooltips();
            // Load saved language or default to Bulgarian
            const savedLanguage = localStorage.getItem('language') || 'bg';
            currentLanguage = savedLanguage;
            loadLanguage(); // Initialize language system
            updateLanguage(); // Update UI language display
            displayHistory(); // –ó–∞—Ä–µ–∂–¥–∞–º–µ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ —Å–ª–µ–¥ –∫–∞—Ç–æ –µ–∑–∏–∫—ä—Ç –µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            updatePointsContainerVisibility(); // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –≤–∏–¥–∏–º–æ—Å—Ç—Ç–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ç–æ—á–∫–∏
            // Auto-calculate with initial values
            setTimeout(() => {
                computeAndRender();
            }, 100); // –ú–∞–ª–∫–æ –∑–∞–∫—ä—Å–Ω–µ–Ω–∏–µ –∑–∞ –¥–∞ —Å–µ –∑–∞—Ä–µ–¥–∏ DOM-–∞ –Ω–∞–ø—ä–ª–Ω–æ
        });
        
        // Dark mode functions
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('dark-mode-toggle');
            if (btn) {
                btn.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }
            localStorage.setItem('darkMode', isDarkMode);
        }
        
        function loadDarkMode() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                const btn = document.getElementById('dark-mode-toggle');
                if (btn) {
                    btn.textContent = '‚òÄÔ∏è';
                }
            }
        }
        
        // Language functions (new working version)
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'bg' ? 'en' : 'bg';
            updateLanguage();
            localStorage.setItem('language', currentLanguage);
        }
        
        function updateLanguage() {
            console.log('updateLanguage called, currentLanguage:', currentLanguage);
            const t = translations[currentLanguage];
            console.log('translations object:', t);
            
            // Update language toggle button
            const langText = document.getElementById('lang-text');
            if (langText) {
                langText.textContent = currentLanguage === 'bg' ? 'EN' : '–ë–ì';
            }
            
            // Update main title
            const mainTitle = document.getElementById('main-title');
            if (mainTitle && t && t.mainTitle) {
                console.log('Setting mainTitle to:', t.mainTitle);
                mainTitle.innerHTML = t.mainTitle;
            }
            
            // Update section title
            const sectionTitle = document.getElementById('section-title');
            if (sectionTitle && t && t.sectionTitle) {
                sectionTitle.textContent = t.sectionTitle;
            }
            
            // Update all labels
            const lLabel = document.getElementById('l-label');
            if (lLabel && t && t.lLabel) {
                lLabel.textContent = t.lLabel;
            }
            
            const dLabel = document.getElementById('d-label');
            if (dLabel && t && t.dLabel) {
                dLabel.textContent = t.dLabel;
            }
            
            const thetaLabel = document.getElementById('theta-label');
            if (thetaLabel && t && t.thetaLabel) {
                thetaLabel.textContent = t.thetaLabel;
            }
            
            const thetaLockLabel = document.getElementById('theta-lock-label');
            if (thetaLockLabel && t && t.thetaLock) {
                thetaLockLabel.textContent = t.thetaLock;
            }
            
            const betaLabel = document.getElementById('beta-label');
            if (betaLabel && t && t.betaLabel) {
                betaLabel.textContent = t.betaLabel;
            }
            
            const coordLabel = document.getElementById('coord-label');
            if (coordLabel && t && t.coordLabel) {
                coordLabel.textContent = t.coordLabel;
            }
            
            // Update history section
            const historyTitle = document.getElementById('history-title');
            if (historyTitle && t && t.historyTitle) {
                historyTitle.textContent = t.historyTitle;
            }
            
            const saveBtn = document.getElementById('save-btn');
            if (saveBtn && t && t.saveBtn) {
                saveBtn.textContent = t.saveBtn;
            }
            
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            if (clearHistoryBtn && t && t.clearHistoryBtn) {
                clearHistoryBtn.textContent = t.clearHistoryBtn;
            }
            
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn && t && t.resetBtn) {
                resetBtn.textContent = t.resetBtn;
            }
            
            // –û–±–Ω–æ–≤—è–≤–∞–º–µ –∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∫–æ–≥–∞—Ç–æ —Å–µ —Å–º–µ–Ω—è –µ–∑–∏–∫–∞
            displayHistory();
        }
        
        function loadLanguage() {
            const savedLang = localStorage.getItem('language');
            if (savedLang && translations[savedLang]) {
                currentLanguage = savedLang;
            }
            updateLanguage(); // –í–∏–Ω–∞–≥–∏ –∏–∑–≤–∏–∫–≤–∞–º–µ –∑–∞ –¥–∞ —Å–µ –Ω–∞—Å—Ç—Ä–æ–∏ –ø—Ä–∞–≤–∏–ª–Ω–æ –±—É—Ç–æ–Ω–∞
        }
        // –í–∞–ª–∏–¥–∏—Ä–∞–Ω–µ –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ
        function setupValidation() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = this.value;
                    if (value === '' || isNaN(value) || parseFloat(value) <= 0) {
                        this.classList.remove('valid');
                        this.classList.add('invalid');
                    } else {
                        this.classList.remove('invalid');
                        this.classList.add('valid');
                    }
                    // Auto-calculate on input change
                    autoCalculate();
                });
            });
        }
        function autoCalculate() {
            // –ó–∞–¥—ä—Ä–∂–∞–º–µ —Å –º–∞–ª–∫–æ –∑–∞–∫—ä—Å–Ω–µ–Ω–∏–µ, –∑–∞ –¥–∞ –Ω–µ —Å–µ –∏–∑—á–∏—Å–ª—è–≤–∞ –Ω–∞ –≤—Å–µ–∫–∏ character
            clearTimeout(window.calcTimeout);
            window.calcTimeout = setTimeout(() => {
                calculate();
            }, 300);
        }
        // Tooltip
        function setupTooltips() {
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                const parent = label.parentElement;
                const infoText = parent.querySelector('.info-text');
                if (infoText) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'tooltip-container';
                    label.parentNode.insertBefore(wrapper, label);
                    wrapper.appendChild(label);
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = infoText.textContent;
                    wrapper.appendChild(tooltip);
                }
            });
        }
        function addPoint(mode) {
            const container = document.getElementById(mode + '-points');
            const pointCount = container.children.length + 1;
            const t = translations[currentLanguage];
            const pointGroup = document.createElement('div');
            pointGroup.className = 'point-group';
            pointGroup.innerHTML = `
                <h4>${t.pointLabel} ${pointCount}</h4>
                <div class="point-inputs">
                    <input type="number" class="x-coord" placeholder="${t.placeholderX}" step="0.1">
                    <input type="number" class="y-coord" placeholder="${t.placeholderY}" step="0.1">
                    <input type="number" class="z-coord" placeholder="${t.placeholderZ}" step="0.1">
                    <button class="remove-point-btn" onclick="removePoint(this)">${t.removeBtn}</button>
                </div>
            `;
            container.appendChild(pointGroup);
            updatePointsContainerVisibility();
            // Setup auto-calculate for new inputs
            const newInputs = pointGroup.querySelectorAll('input[type="number"]');
            newInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = this.value;
                    if (value === '' || isNaN(value)) {
                        this.classList.remove('valid');
                        this.classList.add('invalid');
                    } else {
                        this.classList.remove('invalid');
                        this.classList.add('valid');
                    }
                    autoCalculate();
                });
            });
            autoCalculate();
        }
        function removePoint(btn) {
            btn.closest('.point-group').remove();
            updatePointNumbers();
            updatePointsContainerVisibility();
            autoCalculate();
        }
        function updatePointsContainerVisibility() {
            const container = document.getElementById('sw-points');
            // The sw-points container doesn't exist in the current interface
            // This function is legacy code and can be safely skipped
            if (!container) {
                return;
            }
            const pointGroups = container.querySelectorAll('.point-group');
            
            if (pointGroups.length === 0) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
            }
        }
        function updatePointNumbers() {
            const mode = currentMode;
            const container = document.getElementById(mode + '-points');
            const t = translations[currentLanguage];
            container.querySelectorAll('.point-group').forEach((group, idx) => {
                group.querySelector('h4').textContent = `${t.pointLabel} ${idx + 1}`;
            });
        }
        function calculateAngles(l, d, theta, beta, coordinates) {
            // –ò–∑–≤–ª–∏—á–∞–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ —Å –≤—ä–Ω—à–Ω–∞—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            const xM = coordinates.map(coord => coord.x);
            const yM = coordinates.map(coord => coord.y);
            const zM = coordinates.map(coord => coord.z);
            // –í–ê–ñ–ù–û: –¢–µ–∑–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Å–∞ –≤ SW —Å–∏—Å—Ç–µ–º–∞ –∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–∞—Ç –≤ drill (M) —Å–∏—Å—Ç–µ–º–∞
            // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ wrapper —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ –∑–∞ –ø—Ä–∞–≤–∏–ª–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è SW ‚Üí M
            const result = DrillAngleCalculator.calculateAngleFromSW(l, d, theta, beta, xM, yM, zM);
            // –í—Ä—ä—â–∞–º–µ —Å–∞–º–æ —ä–≥–ª–∏—Ç–µ Œ±f
            return result.alphaRAD;
        }
        function calculate() {
            clearError();
            try {
                let l, d, theta, beta, coordinates = [];
                const lEl = document.getElementById('l-slider');
                const dEl = document.getElementById('d-slider');
                const thetaEl = document.getElementById('theta-slider');
                const betaEl = document.getElementById('beta-slider');
                
                // Check if elements exist before accessing .value
                if (!lEl || !dEl || !thetaEl || !betaEl) {
                    console.warn('Parameter elements not found, skipping calculate()');
                    return;
                }
                
                l = parseFloat(lEl.value);
                d = parseFloat(dEl.value);
                theta = DrillAngleCalculator.deg2rad(parseFloat(thetaEl.value));
                beta = DrillAngleCalculator.deg2rad(parseFloat(betaEl.value));
                
                // Get coordinates from the interactive interface
                const xEl = document.getElementById('x-slider');
                const yEl = document.getElementById('y-slider');
                const zEl = document.getElementById('z-slider');
                
                if (xEl && yEl && zEl) {
                    const x = parseFloat(xEl.value);
                    const y = parseFloat(yEl.value);
                    const z = parseFloat(zEl.value);
                    // –î–æ–±–∞–≤—è–º–µ —Ç–æ—á–∫–∞—Ç–∞ —Å–∞–º–æ –∞–∫–æ –≤—Å–∏—á–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Å–∞ –≤–∞–ª–∏–¥–Ω–∏ —á–∏—Å–ª–∞
                    if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                        coordinates.push({ x: x, y: y, z: z });
                    }
                }
                
                if (coordinates.length === 0) {
                    // No point to calculate, skip
                    return;
                }
                if (isNaN(l) || isNaN(d) || isNaN(theta) || isNaN(beta)) {
                    // Invalid parameters, skip
                    return;
                }
                
                // Note: This function is legacy and not actively used
                // The main calculation is done by computeAndRender()
            } catch (err) {
                console.error('Error in calculate():', err);
            }
        }
        function resetForm() {
            // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Å–∞–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ, –∑–∞–ø–∞–∑–≤–∞–º–µ –±—Ä–æ—è –Ω–∞ —Ç–æ—á–∫–∏—Ç–µ
            document.querySelectorAll('input[type="number"]').forEach(input => {
                // –ó–∞–ø–∞–∑–≤–∞–º–µ –ø–æ–ª–µ—Ç–æ –∑–∞ –±—Ä–æ–π —Ç–æ—á–∫–∏, –∏–∑—á–∏—Å—Ç–≤–∞–º–µ –æ—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ
                if (input.id !== 'sw-points-count') {
                    input.value = '';
                }
            });
            // –ù–ï –ø—Ä–µ–º–∞—Ö–≤–∞–º–µ —Ç–æ—á–∫–∏—Ç–µ, —Å–∞–º–æ –∏–∑—á–∏—Å—Ç–≤–∞–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –∏–º
            
            // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –Ω–∞–ø—ä–ª–Ω–æ
            const t = translations[currentLanguage];
            document.getElementById('results-content').innerHTML = `<div class="results-empty">${t.emptyStateInput}</div>`;
            document.getElementById('results').classList.remove('active');
            updatePointsContainerVisibility(); // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –≤–∏–¥–∏–º–æ—Å—Ç—Ç–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            clearError();
        }
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.add('active');
        }
        function clearError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.remove('active');
        }
        function copyResults() {
            const resultsContent = document.getElementById('results-content').innerText;
            const t = translations[currentLanguage];
            if (resultsContent.trim() === '') {
                showError(t.noResultsToCopy);
                return;
            }
            navigator.clipboard.writeText(resultsContent).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.textContent = t.copiedBtn;
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = t.copyBtn;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function toggleHistory() {
            // –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –≤–∏–Ω–∞–≥–∏ –≤–∏–¥–∏–º–∞, –ø—Ä–æ—Å—Ç–æ –∑–∞—Ä–µ–∂–¥–∞–º–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ
            displayHistory();
        }

        function saveToHistory() {
            // –û—Å–∏–≥—É—Ä—è–≤–∞–º–µ —á–µ currentLanguage –µ –∑–∞–¥–∞–¥–µ–Ω
            if (!currentLanguage || !translations[currentLanguage]) {
                currentLanguage = localStorage.getItem('language') || 'bg';
            }
            const t = translations[currentLanguage];
            
            // –ü–æ–ª—É—á–∞–≤–∞–º–µ —Ç–µ–∫—É—â–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            // –£–≤–µ–ª–∏—á–∞–≤–∞–º–µ –±—Ä–æ—è –Ω–∞ –∑–∞–ø–∞–∑–µ–Ω–∏—Ç–µ —Ç–æ—á–∫–∏
            savedPointCounter++;
            localStorage.setItem('savedPointCounter', savedPointCounter.toString());
            
            const inputs = {
                l: document.getElementById('l-slider')?.value || '',
                d: document.getElementById('d-slider')?.value || '',
                theta: document.getElementById('theta-slider')?.value || '',
                beta: document.getElementById('beta-slider')?.value || '',
                points: [{
                    x: document.getElementById('x-slider')?.value || '',
                    y: document.getElementById('y-slider')?.value || '',
                    z: document.getElementById('z-slider')?.value || '',
                    index: savedPointCounter
                }]
            };

            const alphaValue = document.getElementById('alphaValue')?.textContent || '‚Äî';
            const results = {
                count: 1,
                results: [{
                    label: currentLanguage === 'bg' ? '–ó–∞–¥–µ–Ω —ä–≥—ä–ª Œ±' : 'Side clearance angle Œ±',
                    value: alphaValue
                }],
                coordinates: [{
                    x: inputs.points[0].x,
                    y: inputs.points[0].y,
                    z: inputs.points[0].z,
                    angle: alphaValue
                }],
                summary: currentLanguage === 'bg' ? `–ò–∑—á–∏—Å–ª–µ–Ω 1 —ä–≥—ä–ª: ${alphaValue}` : `Calculated 1 angle: ${alphaValue}`
            };

            if (!results || results.summary.includes('‚Äî') || alphaValue === (currentLanguage === 'bg' ? '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...' : 'Loading...') || alphaValue === 'math NOT loaded') {
                alert(currentLanguage === 'bg' ? '–ù—è–º–∞ –≤–∞–ª–∏–¥–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ!' : 'No valid results to save!');
                return;
            }

            let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            const timestamp = new Date().toLocaleString(currentLanguage === 'bg' ? 'bg-BG' : 'en-US');
            const entry = {
                timestamp: timestamp,
                inputs: inputs,
                results: results
            };
            history.unshift(entry);
            if (history.length > 20) history = history.slice(0, 20);
            localStorage.setItem('calculationHistory', JSON.stringify(history));
            displayHistory();
            
            // –ü–æ–∫–∞–∑–≤–∞–º–µ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = currentLanguage === 'bg' ? '‚úì –ó–∞–ø–∞–∑–µ–Ω–æ' : '‚úì Saved';
            saveBtn.style.background = '#10b981';
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 2000);
        }
        function displayHistory() {
            const historyContainer = document.getElementById('history-container');
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            
            // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ —Ç–µ–∫—É—â–∏—è –µ–∑–∏–∫
            const isEnglish = (currentLanguage === 'en');
            
            const labels = {
                historyEmpty: isEnglish ? "No saved calculations" : "–ù—è–º–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è",
                historyParams: isEnglish ? "Parameters" : "–ü–∞—Ä–∞–º–µ—Ç—Ä–∏", 
                historyResults: isEnglish ? "Results" : "–†–µ–∑—É–ª—Ç–∞—Ç–∏",
                historyCoords: isEnglish ? "Coordinates and angles" : "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∏ —ä–≥–ª–∏",
                historyPoint: isEnglish ? "Point" : "–¢–æ—á–∫–∞",
                historyNoResults: isEnglish ? "No results" : "–ù—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏"
            };
            
            if (history.length === 0) {
                historyContainer.innerHTML = `<p>${labels.historyEmpty}</p>`;
                return;
            }
            
            historyContainer.innerHTML = history.map((entry, index) => `
                <div class="history-item" onclick="loadHistoryItem(${index})">
                    <div class="history-timestamp">${entry.timestamp}</div>
                    <div class="history-preview">
                        <strong>${labels.historyParams}:</strong> l: ${entry.inputs.l}–º–º, d: ${entry.inputs.d}–º–º, Œ∏: ${entry.inputs.theta}¬∞, Œ≤: ${entry.inputs.beta}¬∞
                        <br><strong>${labels.historyResults}:</strong> ${entry.results?.summary || labels.historyNoResults}
                        ${entry.results?.coordinates && entry.results.coordinates.length > 0 ? 
                            `<br><strong>${labels.historyCoords}:</strong><br>` + 
                            entry.results.coordinates.map((coord, i) => {
                                // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ –∑–∞–ø–∞–∑–µ–Ω–∏—è index –æ—Ç —Ç–æ—á–∫–∞—Ç–∞, –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞, –∏–Ω–∞—á–µ i+1
                                const pointNumber = (entry.inputs?.points && entry.inputs.points[i]?.index) 
                                    ? entry.inputs.points[i].index 
                                    : i+1;
                                return `${labels.historyPoint} ${pointNumber}: (${coord.x}, ${coord.y}, ${coord.z}) ‚Üí ${coord.angle}`;
                            }).join('<br>') 
                            : ''
                        }
                    </div>
                </div>
            `).join('');
        }
        function loadHistoryItem(idx) {
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            if (!history[idx]) return;
            
            const entry = history[idx];
            
            // –ó–∞—Ä–µ–∂–¥–∞–º–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('l-slider').value = entry.inputs.l || 85;
            document.getElementById('l-slider-num').value = entry.inputs.l || 85;
            document.getElementById('d-slider').value = entry.inputs.d || 5.7;
            document.getElementById('d-slider-num').value = entry.inputs.d || 5.7;
            document.getElementById('theta-slider').value = entry.inputs.theta || 25;
            document.getElementById('theta-slider-num').value = entry.inputs.theta || 25;
            document.getElementById('beta-slider').value = entry.inputs.beta || 34;
            document.getElementById('beta-slider-num').value = entry.inputs.beta || 34;
            
            // –ó–∞—Ä–µ–∂–¥–∞–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –Ω–∞ –ø—ä—Ä–≤–∞—Ç–∞ —Ç–æ—á–∫–∞
            if (entry.inputs.points && entry.inputs.points.length > 0) {
                const point = entry.inputs.points[0];
                document.getElementById('x-slider').value = point.x || 0;
                document.getElementById('y-slider').value = point.y || 4.84;
                document.getElementById('z-slider').value = point.z || -9.75;
            }
            
            // –ò–∑–≤—ä—Ä—à–≤–∞–º–µ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ—Ç–æ
            computeAndRender();
            
            // –ü–æ–∫–∞–∑–≤–∞–º–µ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ
            const statusBadge = document.getElementById('statusBadge');
            const originalText = statusBadge.textContent;
            const originalClass = statusBadge.className;
            statusBadge.textContent = translations[currentLanguage].loadedFromHistory;
            statusBadge.className = 'status-badge ok';
            setTimeout(() => {
                computeAndRender(); // –í—Ä—ä—â–∞–º–µ –Ω–æ—Ä–º–∞–ª–Ω–∏—è —Å—Ç–∞—Ç—É—Å
            }, 2000);
        }
        function clearHistory() {
            localStorage.removeItem('calculationHistory');
            // –ù—É–ª–∏—Ä–∞–º–µ –±—Ä–æ—è—á—ä—Ç –∑–∞ —Ç–æ—á–∫–∏—Ç–µ
            savedPointCounter = 0;
            localStorage.setItem('savedPointCounter', '0');
            displayHistory();
        }
        function getCurrentResults() {
            const resultsContent = document.getElementById('results-content');
            if (!resultsContent) return null;
            
            // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –∏–º–∞ –≤–∞–ª–∏–¥–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ (–Ω–µ –ø—Ä–∞–∑–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ)
            const isEmpty = resultsContent.querySelector('.results-empty');
            if (isEmpty) return null;
            
            // –ò–∑–≤–ª–∏—á–∞–º–µ –≤—Å–∏—á–∫–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
            const resultItems = resultsContent.querySelectorAll('.result-item');
            if (resultItems.length === 0) return null;
            
            const results = [];
            const coordinates = [];
            
            resultItems.forEach((item, index) => {
                const label = item.querySelector('.result-label')?.textContent || '';
                const value = item.querySelector('.result-value')?.textContent || '';
                results.push({ label, value });
                
                // –ò–∑–≤–ª–∏—á–∞–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –∑–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∞—Ç–∞ —Ç–æ—á–∫–∞
                const pointGroups = document.querySelectorAll('.point-group');
                if (pointGroups[index]) {
                    const inputs = pointGroups[index].querySelectorAll('input');
                    coordinates.push({
                        x: inputs[0]?.value || '',
                        y: inputs[1]?.value || '',
                        z: inputs[2]?.value || '',
                        angle: value
                    });
                }
            });
            
            return {
                count: results.length,
                results: results,
                coordinates: coordinates,
                summary: currentLanguage === 'bg' ? 
                    `–ò–∑—á–∏—Å–ª–µ–Ω–∏ ${results.length} —ä–≥—ä–ª–∞` : 
                    `Calculated ${results.length} angles`
            };
        }
        function getInputValues() {
            // –°—ä–±–µ—Ä—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –≤—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏ –æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            const inputs = {
                l: document.getElementById('l-slider')?.value || '',
                d: document.getElementById('d-slider')?.value || '',
                theta: document.getElementById('theta-slider')?.value || '',
                beta: document.getElementById('beta-slider')?.value || '',
                points: []
            };
            
            // –°—ä–±–µ—Ä—è–≤–∞–Ω–µ –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –Ω–∞ —Ç–æ—á–∫–∞—Ç–∞ –æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            const x = document.getElementById('x-slider')?.value || '';
            const y = document.getElementById('y-slider')?.value || '';
            const z = document.getElementById('z-slider')?.value || '';
            if (x || y || z) {
                inputs.points.push({ x, y, z, index: 1 });
            }
            
            return inputs;
        }
        // –ü–æ–∑–≤–æ–ª—è–≤–∞–Ω–µ –Ω–∞ Enter –∑–∞ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                calculate();
            }
        });

        // === –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–ò –ö–û–ù–¢–†–û–õ–ò ===
        
        const VIS_MIN = 0, VIS_MAX = 40; // visualization range for indicator
        const VALID_MIN = 5, VALID_MAX = 35; // acceptable alpha range
        let currentSumDeg = 59.0; // –ü—Ä–æ–º–µ–Ω–ª–∏–≤–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç —Å–ø–æ—Ä–µ–¥ –∏–∑–±—Ä–∞–Ω–∏—è –ø—Ä–µ—Å–µ—Ç
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—Ç–∞ —Å—É–º–∞ –æ—Ç —Ä–∞–¥–∏–æ –±—É—Ç–æ–Ω–∏—Ç–µ
        function getActiveSumDeg() {
            const selectedPreset = document.querySelector('input[name="anglePreset"]:checked');
            if (!selectedPreset) return null;
            
            switch(selectedPreset.value) {
                case '59': return 59.0;
                case '62.5': return 62.5;
                case '67.5': return 67.5;
                default: return null; // –ù—è–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–∞–Ω–µ
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –µ –∞–∫—Ç–∏–≤–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–∞–Ω–µ
        function isAutoAdjustActive() {
            return getActiveSumDeg() !== null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —Å–ª–∞–π–¥–µ—Ä–∏
        function bindSlider(rangeEl, numEl, onChange) {
            if (!rangeEl || !numEl) return;
            rangeEl.addEventListener('input', () => {
                numEl.value = rangeEl.value;
                onChange();
            });
            numEl.addEventListener('input', () => {
                const v = parseFloat(numEl.value);
                if (!isNaN(v)) rangeEl.value = v;
                onChange();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ/—Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è —Ä–µ–∂–∏–º
        function toggleInteractive() {
            const section = document.getElementById('interactive-section');
            const btn = document.querySelector('.btn-interactive');
            if (!section || !btn) return;

            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.textContent = '–°–∫—Ä–∏–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è —Ä–µ–∂–∏–º';
                initializeInteractiveMode();
            } else {
                section.style.display = 'none';
                btn.textContent = '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è —Ä–µ–∂–∏–º
        function initializeInteractiveMode() {
            const els = {
                l: document.getElementById('l-slider'),
                lNum: document.getElementById('l-slider-num'),
                d: document.getElementById('d-slider'),
                dNum: document.getElementById('d-slider-num'),
                theta: document.getElementById('theta-slider'),
                thetaNum: document.getElementById('theta-slider-num'),
                beta: document.getElementById('beta-slider'),
                betaNum: document.getElementById('beta-slider-num'),
                x: document.getElementById('x-slider'),
                y: document.getElementById('y-slider'),
                z: document.getElementById('z-slider'),
                alphaValue: document.getElementById('alphaValue'),
                statusBadge: document.getElementById('statusBadge'),
                xMval: document.getElementById('xMval'),
                hVal: document.getElementById('hVal'),
                marker: document.getElementById('marker'),
                rangeInfo: document.getElementById('rangeInfo')
            };

            // –°–≤—ä—Ä–∑–≤–∞–Ω–µ –Ω–∞ —Å–ª–∞–π–¥–µ—Ä–∏—Ç–µ —Å –ø–æ–ª–µ—Ç–∞—Ç–∞
            bindSlider(els.l, els.lNum, computeAndRender);
            bindSlider(els.d, els.dNum, computeAndRender);

            // –°–ø–µ—Ü–∏–∞–ª–Ω–∏ event listeners –∑–∞ Œ∏ –∏ Œ≤ –∑–∞—Ä–∞–¥–∏ sum constraint
            if (els.theta && els.thetaNum) {
                els.theta.addEventListener('input', () => {
                    const thetaLock = document.getElementById('theta-lock');
                    if (thetaLock && thetaLock.checked) {
                        // –ê–∫–æ –µ –∑–∞–∫–ª—é—á–µ–Ω–æ, –Ω–µ –ø–æ–∑–≤–æ–ª—è–≤–∞–π –ø—Ä–æ–º—è–Ω–∞
                        els.theta.value = thetaLock.dataset.lockedValue || 25;
                        els.thetaNum.value = els.theta.value;
                        return;
                    }
                    els.thetaNum.value = els.theta.value;
                    if (isAutoAdjustActive()) {
                        const sumDeg = getActiveSumDeg();
                        els.beta.value = (sumDeg - Number(els.theta.value)).toFixed(2);
                        els.betaNum.value = els.beta.value;
                    }
                    computeAndRender();
                });
                els.thetaNum.addEventListener('input', () => {
                    const thetaLock = document.getElementById('theta-lock');
                    if (thetaLock && thetaLock.checked) {
                        // –ê–∫–æ –µ –∑–∞–∫–ª—é—á–µ–Ω–æ, –Ω–µ –ø–æ–∑–≤–æ–ª—è–≤–∞–π –ø—Ä–æ–º—è–Ω–∞
                        els.thetaNum.value = thetaLock.dataset.lockedValue || 25;
                        els.theta.value = els.thetaNum.value;
                        return;
                    }
                    const v = parseFloat(els.thetaNum.value);
                    if (!isNaN(v)) {
                        els.theta.value = v;
                        if (isAutoAdjustActive()) {
                            const sumDeg = getActiveSumDeg();
                            els.beta.value = (sumDeg - v).toFixed(2);
                            els.betaNum.value = els.beta.value;
                        }
                    }
                    computeAndRender();
                });
            }

            // –õ–æ–≥–∏–∫–∞ –∑–∞ –∑–∞–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ Œ∏
            const thetaLock = document.getElementById('theta-lock');
            if (thetaLock && els.theta && els.thetaNum) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–π –∑–∞–∫–ª—é—á–µ–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ (–∞–∫–æ –µ checked –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ)
                if (thetaLock.checked) {
                    thetaLock.dataset.lockedValue = els.theta.value;
                }
                
                thetaLock.addEventListener('change', () => {
                    if (thetaLock.checked) {
                        // –ó–∞–ø–∞–∑–∏ —Ç–µ–∫—É—â–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –∫–∞—Ç–æ –∑–∞–∫–ª—é—á–µ–Ω–∞
                        thetaLock.dataset.lockedValue = els.theta.value;
                        els.theta.disabled = true;
                        els.thetaNum.disabled = true;
                        els.theta.style.opacity = '0.5';
                        els.thetaNum.style.opacity = '0.5';
                        
                        // –ê–∫–æ –∏–º–∞ –∞–∫—Ç–∏–≤–µ–Ω Kr preset, –∏–∑—á–∏—Å–ª–∏ –∏ –∑–∞–∫–ª—é—á–∏ Œ≤
                        if (isAutoAdjustActive()) {
                            const sumDeg = getActiveSumDeg();
                            const currentTheta = Number(els.theta.value);
                            els.beta.value = (sumDeg - currentTheta).toFixed(2);
                            els.betaNum.value = els.beta.value;
                            els.beta.disabled = true;
                            els.betaNum.disabled = true;
                            els.beta.style.opacity = '0.5';
                            els.betaNum.style.opacity = '0.5';
                        }
                    } else {
                        // –û—Ç–∫–ª—é—á–∏ Œ∏
                        els.theta.disabled = false;
                        els.thetaNum.disabled = false;
                        els.theta.style.opacity = '1';
                        els.thetaNum.style.opacity = '1';
                        
                        // –û—Ç–∫–ª—é—á–∏ –∏ Œ≤
                        els.beta.disabled = false;
                        els.betaNum.disabled = false;
                        els.beta.style.opacity = '1';
                        els.betaNum.style.opacity = '1';
                    }
                });
            }

            if (els.beta && els.betaNum) {
                els.beta.addEventListener('input', () => {
                    const thetaLock = document.getElementById('theta-lock');
                    const isThetaLocked = thetaLock && thetaLock.checked;
                    
                    // –ê–∫–æ Œ∏ –µ –∑–∞–∫–ª—é—á–µ–Ω –∏ –∏–º–∞ –∞–∫—Ç–∏–≤–µ–Ω Kr preset, –±–ª–æ–∫–∏—Ä–∞–π –ø—Ä–æ–º—è–Ω–∞—Ç–∞ –Ω–∞ Œ≤
                    if (isThetaLocked && isAutoAdjustActive()) {
                        const sumDeg = getActiveSumDeg();
                        const lockedTheta = Number(els.theta.value);
                        els.beta.value = (sumDeg - lockedTheta).toFixed(2);
                        els.betaNum.value = els.beta.value;
                        return;
                    }
                    
                    els.betaNum.value = els.beta.value;
                    if (isAutoAdjustActive()) {
                        const sumDeg = getActiveSumDeg();
                        els.theta.value = (sumDeg - Number(els.beta.value)).toFixed(2);
                        els.thetaNum.value = els.theta.value;
                    }
                    computeAndRender();
                });
                els.betaNum.addEventListener('input', () => {
                    const thetaLock = document.getElementById('theta-lock');
                    const isThetaLocked = thetaLock && thetaLock.checked;
                    
                    // –ê–∫–æ Œ∏ –µ –∑–∞–∫–ª—é—á–µ–Ω –∏ –∏–º–∞ –∞–∫—Ç–∏–≤–µ–Ω Kr preset, –±–ª–æ–∫–∏—Ä–∞–π –ø—Ä–æ–º—è–Ω–∞—Ç–∞ –Ω–∞ Œ≤
                    if (isThetaLocked && isAutoAdjustActive()) {
                        const sumDeg = getActiveSumDeg();
                        const lockedTheta = Number(els.theta.value);
                        els.beta.value = (sumDeg - lockedTheta).toFixed(2);
                        els.betaNum.value = els.beta.value;
                        return;
                    }
                    
                    const v = parseFloat(els.betaNum.value);
                    if (!isNaN(v)) {
                        els.beta.value = v;
                        if (isAutoAdjustActive()) {
                            const sumDeg = getActiveSumDeg();
                            els.theta.value = (sumDeg - v).toFixed(2);
                            els.thetaNum.value = els.theta.value;
                        }
                    }
                    computeAndRender();
                });
            }

            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
            [els.x, els.y, els.z].forEach(e => {
                if (e) e.addEventListener('input', computeAndRender);
            });

            // Event listeners –∑–∞ —Ä–∞–¥–∏–æ –±—É—Ç–æ–Ω–∏—Ç–µ –∑–∞ –ø—Ä–µ—Å–µ—Ç–∏
            const anglePresetRadios = document.querySelectorAll('input[name="anglePreset"]');
            anglePresetRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const thetaLock = document.getElementById('theta-lock');
                    const isThetaLocked = thetaLock && thetaLock.checked;
                    
                    if (isAutoAdjustActive()) {
                        const sumDeg = getActiveSumDeg();
                        const currentTheta = Number(els.theta.value);
                        
                        // –ê–∫–æ Œ∏ –µ –∑–∞–∫–ª—é—á–µ–Ω, –∏–∑—á–∏—Å–ª–∏ Œ≤ –∏ –≥–æ –∑–∞–∫–ª—é—á–∏
                        if (isThetaLocked) {
                            els.beta.value = (sumDeg - currentTheta).toFixed(2);
                            els.betaNum.value = els.beta.value;
                            // –ó–∞–∫–ª—é—á–∏ Œ≤
                            els.beta.disabled = true;
                            els.betaNum.disabled = true;
                            els.beta.style.opacity = '0.5';
                            els.betaNum.style.opacity = '0.5';
                        } else {
                            // –ê–∫–æ Œ∏ –Ω–µ –µ –∑–∞–∫–ª—é—á–µ–Ω, —Ä–∞–±–æ—Ç–∏ –Ω–æ—Ä–º–∞–ª–Ω–æ
                            els.beta.value = (sumDeg - currentTheta).toFixed(2);
                            els.betaNum.value = els.beta.value;
                        }
                    } else {
                        // –ê–∫–æ –µ –∏–∑–±—Ä–∞–Ω–æ "–ë–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–∞–Ω–µ", –æ—Ç–∫–ª—é—á–∏ Œ≤
                        if (isThetaLocked) {
                            els.beta.disabled = false;
                            els.betaNum.disabled = false;
                            els.beta.style.opacity = '1';
                            els.betaNum.style.opacity = '1';
                        }
                    }
                    computeAndRender();
                });
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω–∏—Ç–µ –ø–æ–ª–µ—Ç–∞
            syncWithMainForm();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∞–∫–æ Œ∏ –µ –∑–∞–∫–ª—é—á–µ–Ω –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ –∏ –∏–º–∞ –∞–∫—Ç–∏–≤–µ–Ω Kr preset, –∑–∞–∫–ª—é—á–∏ –∏ Œ≤
            const thetaLockInit = document.getElementById('theta-lock');
            if (thetaLockInit && thetaLockInit.checked && isAutoAdjustActive()) {
                const sumDeg = getActiveSumDeg();
                const currentTheta = Number(els.theta.value);
                els.beta.value = (sumDeg - currentTheta).toFixed(2);
                els.betaNum.value = els.beta.value;
                els.beta.disabled = true;
                els.betaNum.disabled = true;
                els.beta.style.opacity = '0.5';
                els.betaNum.style.opacity = '0.5';
            }
            
            computeAndRender();
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–ª–∞–π–¥–µ—Ä–∏—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω–∏—Ç–µ –ø–æ–ª–µ—Ç–∞
        function syncWithMainForm() {
            const mainL = document.getElementById('l-sw');
            const mainD = document.getElementById('d-sw');
            const mainTheta = document.getElementById('theta-sw');
            const mainBeta = document.getElementById('beta-sw');
            
            const firstPoint = document.querySelector('.point-group');
            const firstInputs = firstPoint ? firstPoint.querySelectorAll('input') : [];

            if (mainL) document.getElementById('l-slider').value = mainL.value || 85;
            if (mainD) document.getElementById('d-slider').value = mainD.value || 5.7;
            if (mainTheta) document.getElementById('theta-slider').value = mainTheta.value || 25;
            if (mainBeta) document.getElementById('beta-slider').value = mainBeta.value || 34;

            document.getElementById('l-slider-num').value = document.getElementById('l-slider').value;
            document.getElementById('d-slider-num').value = document.getElementById('d-slider').value;
            document.getElementById('theta-slider-num').value = document.getElementById('theta-slider').value;
            document.getElementById('beta-slider-num').value = document.getElementById('beta-slider').value;

            if (firstInputs.length >= 3) {
                document.getElementById('x-slider').value = firstInputs[0].value || 0;
                document.getElementById('y-slider').value = firstInputs[1].value || 4.84;
                document.getElementById('z-slider').value = firstInputs[2].value || -9.75;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å—É–º–∞—Ç–∞
        function updateSum() {
            // Removed sum display as requested - only checkbox remains
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞
        function setMarker(alpha) {
            const marker = document.getElementById('marker');
            if (!marker) return;

            if (!isFinite(alpha)) {
                marker.style.display = 'none';
                return;
            }

            const clamped = Math.max(VIS_MIN, Math.min(VIS_MAX, alpha));
            const pct = ((clamped - VIS_MIN) / (VIS_MAX - VIS_MIN)) * 100;
            marker.style.left = pct.toFixed(2) + '%';
            marker.style.display = 'block';

            const inRange = (alpha >= VALID_MIN && alpha <= VALID_MAX);
            marker.classList.toggle('ok', inRange);
            marker.classList.toggle('bad', !inRange);
        }

        // –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ä–∞–Ω–µ
        function computeAndRender() {
            const calc = window.DrillAngleCalculator;
            if (!calc) {
                const t = translations[currentLanguage];
                const alphaEl = document.getElementById('alphaValue');
                const statusEl = document.getElementById('statusBadge');
                if (alphaEl) alphaEl.textContent = t.mathNotLoaded;
                if (statusEl) {
                    statusEl.textContent = t.gangleNotAvailable;
                    statusEl.className = 'status-badge bad';
                }
                setMarker(NaN);
                return;
            }

            const lEl = document.getElementById('l-slider');
            const dEl = document.getElementById('d-slider');
            const thetaEl = document.getElementById('theta-slider');
            const betaEl = document.getElementById('beta-slider');
            const xEl = document.getElementById('x-slider');
            const yEl = document.getElementById('y-slider');
            const zEl = document.getElementById('z-slider');
            
            if (!lEl || !dEl || !thetaEl || !betaEl || !xEl || !yEl || !zEl) {
                console.warn('Some slider elements not found, skipping computeAndRender()');
                return;
            }
            
            const l = Number(lEl.value);
            const d = Number(dEl.value);
            const thetaDeg = Number(thetaEl.value);
            const betaDeg = Number(betaEl.value);
            const thetaRad = calc.deg2rad ? calc.deg2rad(thetaDeg) : (thetaDeg * Math.PI / 180);
            const betaRad = calc.deg2rad ? calc.deg2rad(betaDeg) : (betaDeg * Math.PI / 180);
            const x_sw = Number(xEl.value);
            const y_sw = Number(yEl.value);
            const z_sw = Number(zEl.value);

            try {
                let res;
                if (typeof calc.calculateAngleFromSW === 'function') {
                    res = calc.calculateAngleFromSW(l, d, thetaRad, betaRad, x_sw, y_sw, z_sw);
                } else {
                    res = calc.calculateAngle(l, d, thetaRad, betaRad, x_sw, y_sw, z_sw);
                }

                let alpha = NaN, xMout = NaN, hOut = NaN;
                if (res && Array.isArray(res.alphaRAD)) {
                    alpha = res.alphaRAD[0];
                    xMout = (res.xM && res.xM[0] != null) ? res.xM[0] : NaN;
                    hOut = res.h;
                } else if (res && typeof res.alphaRAD === 'number') {
                    alpha = res.alphaRAD;
                    xMout = res.xM;
                    hOut = res.h;
                }

                const alphaElement = document.getElementById('alphaValue');
                const xMvalElement = document.getElementById('xMval');
                const hValElement = document.getElementById('hVal');
                const statusBadge = document.getElementById('statusBadge');
                
                if (alphaElement) alphaElement.textContent = isFinite(alpha) ? alpha.toFixed(4) + '¬∞' : 'NaN';
                if (xMvalElement) xMvalElement.textContent = isFinite(xMout) ? xMout.toFixed(4) : 'NaN';
                if (hValElement) hValElement.textContent = isFinite(hOut) ? hOut.toFixed(4) : 'NaN';

                // –û—Ü–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ —Å–ø–æ—Ä–µ–¥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—Ç–∞
                if (alphaElement && statusBadge) {
                    if (!isFinite(alpha)) {
                        alphaElement.className = 'result-big result-invalid';
                        statusBadge.style.display = 'none'; // –°–∫—Ä–∏–≤–∞–º–µ status badge
                    } else if (alpha < VALID_MIN || alpha > VALID_MAX) {
                        alphaElement.className = 'result-big result-invalid';
                        statusBadge.style.display = 'none';
                    } else {
                        alphaElement.className = 'result-big result-valid';
                        statusBadge.style.display = 'none';
                    }
                }

                setMarker(alpha);
            } catch (err) {
                console.error(err);
                const alphaElement = document.getElementById('alphaValue');
                const statusBadge = document.getElementById('statusBadge');
                if (alphaElement) {
                    alphaElement.textContent = 'Error';
                    alphaElement.className = 'result-big result-invalid';
                }
                if (statusBadge) statusBadge.style.display = 'none';
                setMarker(NaN);
            }
            updateSum();
        }

        // Wrapper function –∑–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∞—Ç–∞ calculate —Ñ—É–Ω–∫—Ü–∏—è
        function calculateResults() {
            calculate(); // –í–∏–∫–∞–º–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ reset –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—Ç–∞ —Ñ–æ—Ä–º–∞
        function resetInteractiveForm() {
            document.getElementById('l-slider').value = 85;
            document.getElementById('l-slider-num').value = 85;
            document.getElementById('d-slider').value = 5.7;
            document.getElementById('d-slider-num').value = 5.7;
            document.getElementById('theta-slider').value = 25;
            document.getElementById('theta-slider-num').value = 25;
            document.getElementById('beta-slider').value = 34;
            document.getElementById('beta-slider-num').value = 34;
            document.getElementById('x-slider').value = 0;
            document.getElementById('y-slider').value = 4.84;
            document.getElementById('z-slider').value = -9.75;
            // –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–µ—Å–µ—Ç–∞ Œ∏ + Œ≤ = 59¬∞ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
            document.querySelector('input[name="anglePreset"][value="59"]').checked = true;
            computeAndRender();
        }

        // –û–±–Ω–æ–≤–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ —Å –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ summary
        function computeAndRender() {
            const calc = window.DrillAngleCalculator;
            if (!calc) {
                const alphaEl = document.getElementById('alphaValue');
                const statusEl = document.getElementById('statusBadge');
                if (alphaEl) alphaEl.textContent = 'math NOT loaded';
                if (statusEl) {
                    statusEl.textContent = 'GAngle.js not available';
                    statusEl.className = 'status-badge bad';
                }
                setMarker(NaN);
                return;
            }

            const lEl = document.getElementById('l-slider');
            const dEl = document.getElementById('d-slider');
            const thetaEl = document.getElementById('theta-slider');
            const betaEl = document.getElementById('beta-slider');
            const xEl = document.getElementById('x-slider');
            const yEl = document.getElementById('y-slider');
            const zEl = document.getElementById('z-slider');
            
            if (!lEl || !dEl || !thetaEl || !betaEl || !xEl || !yEl || !zEl) {
                console.warn('Some slider elements not found, skipping computeAndRender()');
                return;
            }
            
            const l = Number(lEl.value);
            const d = Number(dEl.value);
            const thetaDeg = Number(thetaEl.value);
            const betaDeg = Number(betaEl.value);
            const thetaRad = calc.deg2rad ? calc.deg2rad(thetaDeg) : (thetaDeg * Math.PI / 180);
            const betaRad = calc.deg2rad ? calc.deg2rad(betaDeg) : (betaDeg * Math.PI / 180);
            const x_sw = Number(xEl.value);
            const y_sw = Number(yEl.value);
            const z_sw = Number(zEl.value);

            try {
                let res;
                if (typeof calc.calculateAngleFromSW === 'function') {
                    res = calc.calculateAngleFromSW(l, d, thetaRad, betaRad, x_sw, y_sw, z_sw);
                } else {
                    res = calc.calculateAngle(l, d, thetaRad, betaRad, x_sw, y_sw, z_sw);
                }

                let alpha = NaN, xMout = NaN, hOut = NaN;
                if (res && Array.isArray(res.alphaRAD)) {
                    alpha = res.alphaRAD[0];
                    xMout = (res.xM && res.xM[0] != null) ? res.xM[0] : NaN;
                    hOut = res.h;
                } else if (res && typeof res.alphaRAD === 'number') {
                    alpha = res.alphaRAD;
                    xMout = res.xM;
                    hOut = res.h;
                }

                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è –¥–∏—Å–ø–ª–µ–π
                const alphaElement = document.getElementById('alphaValue');
                const xMvalElement = document.getElementById('xMval');
                const hValElement = document.getElementById('hVal');
                const statusBadge = document.getElementById('statusBadge');
                
                if (alphaElement) alphaElement.textContent = isFinite(alpha) ? alpha.toFixed(4) + '¬∞' : 'NaN';
                if (xMvalElement) xMvalElement.textContent = isFinite(xMout) ? xMout.toFixed(4) : 'NaN';
                if (hValElement) hValElement.textContent = isFinite(hOut) ? hOut.toFixed(4) : 'NaN';

                // –û—Ü–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ —Å–ø–æ—Ä–µ–¥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—Ç–∞
                if (alphaElement && statusBadge) {
                    if (!isFinite(alpha)) {
                        alphaElement.className = 'result-big result-invalid';
                        statusBadge.style.display = 'none';
                    } else if (alpha < VALID_MIN || alpha > VALID_MAX) {
                        alphaElement.className = 'result-big result-invalid';
                        statusBadge.style.display = 'none';
                    } else {
                        alphaElement.className = 'result-big result-valid';
                        statusBadge.style.display = 'none';
                    }
                }

                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ
                updateParamsSummary(l, d, thetaDeg, betaDeg, x_sw, y_sw, z_sw);

                setMarker(alpha);
            } catch (err) {
                console.error(err);
                const alphaElement = document.getElementById('alphaValue');
                const statusBadge = document.getElementById('statusBadge');
                if (alphaElement) {
                    alphaElement.textContent = 'Error';
                    alphaElement.className = 'result-big result-invalid';
                }
                if (statusBadge) statusBadge.style.display = 'none';
                setMarker(NaN);
            }
            updateSum();
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ summary –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ
        function updateParamsSummary(l, d, theta, beta, x, y, z) {
            const summary = `l=${l}–º–º d=${d}–º–º Œ∏=${theta}¬∞ Œ≤=${beta}¬∞ | X=${x} Y=${y} Z=${z}`;
            const paramsSummary = document.getElementById('params-summary');
            if (paramsSummary) {
                paramsSummary.textContent = summary;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        window.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–ø–æ—á–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—è —Ä–µ–∂–∏–º –≤–µ–¥–Ω–∞–≥–∞
            setTimeout(() => {
                initializeInteractiveMode();
            }, 100);
        });
    </script>
</body>
</html>
