<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GAngle — Realtime (uses only GAngle.js from dev)</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=" />
  <style>/* minimal styles */ body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px;background:#f6f7fb} .card{background:#fff;border:1px solid #e6e9ef;padding:14px;border-radius:8px;max-width:1100px;margin:auto} .row{display:flex;gap:8px;align-items:center} input[type=range]{flex:1} .num{width:84px;padding:6px;border-radius:6px;border:1px solid #d7dbe6} .coords{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px} .coor-input{padding:8px;border-radius:6px;border:1px solid #e0e4ee} .big{font-size:28px;font-weight:700} .badge{padding:6px 10px;border-radius:8px;color:#fff;display:inline-block} .ok{background:#2a7a2a}.bad{background:#d62728} .sumDisplay{padding:6px 8px;border-radius:8px;background:#fafafa;border:1px solid #e6e6e6} .note { margin-top:12px;color:#666;font-size:13px } code{background:#f1f5fb;padding:2px 6px;border-radius:4px}

/* range indicator */
.range-wrap{margin-top:14px}
.range-track{height:18px;border-radius:10px;background:linear-gradient(90deg,#d62728 0%,#d62728 12.5%,#2a7a2a 12.5%,#2a7a2a 87.5%,#d62728 87.5%,#d62728 100%);position:relative}
.marker{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:26px;border-radius:4px;background:#333;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
.marker.ok{background:#2a7a2a}
.marker.bad{background:#d62728}
.range-labels{display:flex;justify-content:space-between;font-size:12px;color:#666;margin-top:6px}
.range-info{margin-top:6px;font-size:13px;color:#333}
  </style>
</head>
<body>
  <div class="card">
    <h2>GAngle — Realtime (uses only GAngle.js from dev)</h2>
    <div>
      <label>l [mm]</label>
      <div class="row"><input id="l" type="range" min="10" max="200" step="0.1" value="85"><input id="lNum" class="num" type="number" step="0.1" value="85"></div>
      <label>d [mm]</label>
      <div class="row"><input id="d" type="range" min="0" max="50" step="0.1" value="5.7"><input id="dNum" class="num" type="number" step="0.1" value="5.7"></div>
      <label>θ [°]</label>
      <div class="row"><input id="theta" type="range" min="0" max="59" step="0.1" value="25"><input id="thetaNum" class="num" type="number" step="0.1" value="25"></div>
      <label>β [°]</label>
      <div class="row"><input id="beta" type="range" min="0" max="59" step="0.1" value="34"><input id="betaNum" class="num" type="number" step="0.1" value="34"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><label><input id="lockSum" type="checkbox" checked> Поддържай θ + β = 59°</label><div class="sumDisplay" id="sumDisplay">θ+β = 59.00°</div></div>
      <hr>
      <label>Точка (X, Y, Z) — SW coordinates</label>
      <div class="coords"><input id="x" class="coor-input" type="number" step="0.01" value="0"><input id="y" class="coor-input" type="number" step="0.01" value="4.84"><input id="z" class="coor-input" type="number" step="0.01" value="-9.75"></div>
      <div style="margin-top:12px"><div class="big" id="alphaValue">loading math...</div><div id="statusBadge" class="badge">waiting for GAngle.js</div><div style="margin-top:6px">xM: <span id="xMval">—</span> · h: <span id="hVal">—</span></div></div>

      <!-- Range indicator -->
      <div class="range-wrap">
        <div class="range-track" id="rangeTrack" aria-hidden="false">
          <div id="marker" class="marker" style="left:0%" title="alpha position"></div>
        </div>
        <div class="range-labels"><span>0°</span><span>5° (min)</span><span>20°</span><span>35° (max)</span><span>40°</span></div>
        <div class="range-info" id="rangeInfo">Position: —</div>
      </div>

      <div class="note" id="loaderNote">Това демо зарежда математиката само от <code>GAngle.js</code> в dev (CDN/raw/local fallback enabled).</div>
    </div>
  </div>

  <!-- loader: try CDN (jsDelivr) -> raw.githack -> local ./GAngle.js -->
  <script>
  (function(){
    const sources = [
      'https://cdn.jsdelivr.net/gh/anton-grozev/gangle@dev/GAngle.js',
      'https://raw.githack.com/anton-grozev/gangle/dev/GAngle.js',
      './GAngle.js'
    ];

    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.src=src; s.async=true;
        s.onload=()=>resolve(src); s.onerror=(e)=>reject(new Error('Failed to load '+src)); document.head.appendChild(s);
      });
    }

    (async function tryLoad(){
      const note=document.getElementById('loaderNote');
      for(const src of sources){
        try{ if(note) note.textContent = `Опитваме: ${src}`; await loadScript(src); if(note) note.textContent = `Успешно: ${src}`; console.log('Loaded',src);
          // Give the loaded script a moment to set global
          setTimeout(()=>{ try{ if(window.__gangle_demo && typeof window.__gangle_demo.computeAndRender==='function') window.__gangle_demo.computeAndRender(); }catch(e){console.warn(e);} },80);
          return; } catch(e){ console.warn('load failed',src,e); }
      }
      if(note) note.textContent = 'Не успяхме да заредим GAngle.js (CDN/raw/local)';
      const alpha=document.getElementById('alphaValue'), badge=document.getElementById('statusBadge'); if(alpha) alpha.textContent='math NOT loaded'; if(badge){ badge.textContent='GAngle.js not available'; badge.className='badge bad'; }
    })();
  })();
  </script>

  <script>
  (function(){
    const VIS_MIN = 0, VIS_MAX = 40; // visualization range for indicator
    const VALID_MIN = 5, VALID_MAX = 35; // acceptable alpha range

    const SUM_DEG = 59.0, RANGE_MIN = VALID_MIN, RANGE_MAX = VALID_MAX;
    const els = { l:document.getElementById('l'), lNum:document.getElementById('lNum'), d:document.getElementById('d'), dNum:document.getElementById('dNum'), theta:document.getElementById('theta'), thetaNum:document.getElementById('thetaNum'), beta:document.getElementById('beta'), betaNum:document.getElementById('betaNum'), lockSum:document.getElementById('lockSum'), sumDisplay:document.getElementById('sumDisplay'), x:document.getElementById('x'), y:document.getElementById('y'), z:document.getElementById('z'), alphaValue:document.getElementById('alphaValue'), statusBadge:document.getElementById('statusBadge'), xMval:document.getElementById('xMval'), hVal:document.getElementById('hVal'), loaderNote:document.getElementById('loaderNote'), marker:document.getElementById('marker'), rangeInfo:document.getElementById('rangeInfo') };

    function bind(rangeEl,numEl,onChange){ rangeEl.addEventListener('input',()=>{ numEl.value=rangeEl.value; onChange();}); numEl.addEventListener('input',()=>{ const v=parseFloat(numEl.value); if(!isNaN(v)) rangeEl.value=v; onChange(); }); }

    bind(els.l, els.lNum, computeAndRender); bind(els.d, els.dNum, computeAndRender);
    els.theta.addEventListener('input', ()=>{ els.thetaNum.value = els.theta.value; if(els.lockSum.checked) { els.beta.value = (SUM_DEG - Number(els.theta.value)).toFixed(2); els.betaNum.value = els.beta.value; } computeAndRender(); });
    els.thetaNum.addEventListener('input', ()=>{ const v=parseFloat(els.thetaNum.value); if(!isNaN(v)){ els.theta.value = v; if(els.lockSum.checked){ els.beta.value = (SUM_DEG - v).toFixed(2); els.betaNum.value = els.beta.value; } } computeAndRender(); });
    els.beta.addEventListener('input', ()=>{ els.betaNum.value = els.beta.value; if(els.lockSum.checked){ els.theta.value = (SUM_DEG - Number(els.beta.value)).toFixed(2); els.thetaNum.value = els.theta.value; } computeAndRender(); });
    els.betaNum.addEventListener('input', ()=>{ const v=parseFloat(els.betaNum.value); if(!isNaN(v)){ els.beta.value = v; if(els.lockSum.checked){ els.theta.value = (SUM_DEG - v).toFixed(2); els.thetaNum.value = els.theta.value; } } computeAndRender(); });

    [els.x, els.y, els.z].forEach(e=>e.addEventListener('input', computeAndRender));
    els.lockSum.addEventListener('change', ()=>{ if(els.lockSum.checked){ const t=Number(els.theta.value); els.beta.value = (SUM_DEG - t).toFixed(2); els.betaNum.value = els.beta.value; } computeAndRender(); });

    function updateSum(){ const sum = Number(els.theta.value) + Number(els.beta.value); els.sumDisplay.textContent = `θ+β = ${sum.toFixed(2)}°`; els.sumDisplay.style.color = (Math.abs(sum - SUM_DEG) < 1e-6) ? '#2a7a2a' : '#d62728'; }

    function setMarker(alpha){ const marker = els.marker; const info = els.rangeInfo; if(!marker) return; if(!isFinite(alpha)){ marker.style.display='none'; info.textContent = 'Position: —'; return; } const clamped = Math.max(VIS_MIN, Math.min(VIS_MAX, alpha)); const pct = ((clamped - VIS_MIN) / (VIS_MAX - VIS_MIN)) * 100; marker.style.left = pct.toFixed(2) + '%'; marker.style.display = 'block'; const inRange = (alpha >= VALID_MIN && alpha <= VALID_MAX); marker.classList.toggle('ok', inRange); marker.classList.toggle('bad', !inRange); info.textContent = `Position: ${alpha.toFixed(3)}° — ${inRange? 'within' : 'outside'} ${VALID_MIN}°–${VALID_MAX}°`; }

    function computeAndRender() {
      const calc = window.DrillAngleCalculator;
      if (!calc) { els.alphaValue.textContent='math NOT loaded'; els.statusBadge.textContent='GAngle.js not available'; els.statusBadge.className='badge bad'; setMarker(NaN); return; }

      const hasFromSW = typeof calc.calculateAngleFromSW === 'function';
      const l = Number(els.l.value), d = Number(els.d.value);
      const thetaDeg = Number(els.theta.value), betaDeg = Number(els.beta.value);
      const thetaRad = calc.deg2rad ? calc.deg2rad(thetaDeg) : (thetaDeg * Math.PI/180);
      const betaRad = calc.deg2rad ? calc.deg2rad(betaDeg) : (betaDeg * Math.PI/180);
      const x_sw = Number(els.x.value), y_sw = Number(els.y.value), z_sw = Number(els.z.value);

      try {
        let res;
        if (hasFromSW) {
          res = calc.calculateAngleFromSW(l, d, thetaRad, betaRad, x_sw, y_sw, z_sw);
        } else {
          res = calc.calculateAngle(l, d, thetaRad, betaRad, x_sw, y_sw, z_sw);
        }

        let alpha = NaN, xMout = NaN, hOut = NaN;
        if (res && Array.isArray(res.alphaRAD)) { alpha = res.alphaRAD[0]; xMout = (res.xM && res.xM[0] != null) ? res.xM[0] : NaN; hOut = res.h; }
        else if (res && typeof res.alphaRAD === 'number') { alpha = res.alphaRAD; xMout = res.xM; hOut = res.h; }

        els.alphaValue.textContent = isFinite(alpha) ? alpha.toFixed(4)+'°' : 'NaN';
        els.xMval.textContent = isFinite(xMout) ? xMout.toFixed(4) : 'NaN';
        els.hVal.textContent = isFinite(hOut) ? hOut.toFixed(4) : 'NaN';
        if (!isFinite(alpha)) { els.statusBadge.textContent='No real solution'; els.statusBadge.className='badge bad'; }
        else if (alpha < RANGE_MIN || alpha > RANGE_MAX) { els.statusBadge.textContent='OUTSIDE 5°–35°'; els.statusBadge.className='badge bad'; }
        else { els.statusBadge.textContent='OK 5°–35°'; els.statusBadge.className='badge ok'; }

        setMarker(alpha);
      } catch (err) {
        console.error(err);
        els.alphaValue.textContent='Error'; els.statusBadge.textContent='Error'; els.statusBadge.className='badge bad'; setMarker(NaN);
      }
      updateSum();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=>{ computeAndRender(); }, 80);
    });

    // expose for loader to trigger after successful script load
    window.__gangle_demo = { computeAndRender };
  })();
  </script>
</body>
</html>